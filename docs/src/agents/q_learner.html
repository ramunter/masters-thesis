<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>q_learner.py</title>
  <link rel="stylesheet" href="../../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>q_learner.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">src.agents.util</span> <span class="kn">import</span> <span class="n">featurizer</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Caclulates the target Q-value using temporal differencing.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">calculate_target</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_q_value</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <pre><code>The Q-learning temporal target is Q(s,a) = r + gamma*Q(s', a') if in a 
non-terminal state. Otherwise Q(s,a) = r

args:
</code></pre>
<p>gamma (float): The decay factor.
   reward (int): Reward from action a.
   next_q_value (float): Equivalent to Q(s&rsquo;, a&rsquo;)
   done (bool): Is the current state a terminal state_ </p>
<pre><code>returns:
</code></pre>
<p>target (float): The Q-value target.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">target</span> <span class="o">=</span> <span class="n">reward</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">+=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">next_q_value</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">target</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">target</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Runs a Q-learning experiment using the given environment and agent.</p>
<p>This experiment must use a critic agent. The experiment is run until a
running average of the regret falls below a given threshold or the maximum
number of episodes is reached. Note that this function assumes the optimal
reward is 1.</p>
<p>args:<br />
    env (gym.Environment): The environment to test on.<br />
    Critic (CriticTemplate): The class of the agent to use. Has to be a critic.<br />
    episodes (int): Maximum number of episodes to run.<br />
    verbose (bool): Should this print information about the final model?  </p>
<p>returns:<br />
    episode (int): Number of episodes run.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">q_learner</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">Critic</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    
    <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">critic</span> <span class="o">=</span> <span class="n">Critic</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

    <span class="n">average_regret</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">episodes</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">critic</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">critic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Perform step</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">next_state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Best next action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">next_action</span><span class="p">,</span> <span class="n">next_q_value</span> <span class="o">=</span> <span class="n">critic</span><span class="o">.</span><span class="n">get_target_action_and_q_value</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Update parameters</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">target</span> <span class="o">=</span> <span class="n">calculate_target</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_q_value</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
            <span class="n">critic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Reset loop</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">state</span> <span class="o">=</span> <span class="n">next_state</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">critic</span><span class="o">.</span><span class="n">get_action</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">average_regret</span> <span class="o">-=</span> <span class="n">average_regret</span> <span class="o">/</span> <span class="mi">20</span>
        <span class="n">average_regret</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">reward</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span>

        <span class="k">if</span> <span class="n">average_regret</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="o">*</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># What should &quot;learned&quot; be? </span>
            <span class="k">break</span> <span class="c1"># Check that this does not remove episode</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Final Parameters&quot;</span><span class="p">)</span>
        <span class="n">critic</span><span class="o">.</span><span class="n">print_parameters</span><span class="p">()</span>
        <span class="n">critic</span><span class="o">.</span><span class="n">print_policy</span><span class="p">(</span><span class="n">num_states</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Episodes used: &quot;</span><span class="p">,</span> <span class="n">episode</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">episode</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Template for a critic agent that can be used with the Q-learner</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">CriticTemplate</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>experiment above.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <h1>Functionality</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_target_action_and_q_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_q_value</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">best_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">action</span><span class="p">,</span> <span class="n">q_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_action_and_q_value</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">action</span>

    <span class="k">def</span> <span class="nf">is_policy_optimal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_states</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_action</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_states</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <h1>Debug functions</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">print_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">print_q_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_states</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Left &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_states</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span>
                  <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">()</span>
        
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Right &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_states</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span>
                  <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_value</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">print_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_states</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Policy &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_states</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_action</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
